<!-- Affichage pendant le chargement -->
@if (isLoading) {
  <div class="loading-container text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="text-muted">Salle en cours de chargement...</p>
  </div>
}

<!-- Affichage quand les données sont chargées -->
@if (!isLoading) {
  <!-- Si la salle n'existe pas -->
  @if (!room) {
    <div class="no-room text-center py-5">
      <p class="text-muted fs-5">Salle introuvable</p>
    </div>
  }

  <!-- Si la salle existe -->
  @if (room) {
    <div class="container-fluid p-0">
      <div class="row g-0 d-flex flex-column flex-md-row">
        <!-- Côté gauche : salle info + sliders -->
        <div class="col-12 col-md-3 d-flex flex-column p-3 bg-body text-body">
          <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
            <h3>Informations</h3>

            <div class="d-flex gap-2 flex-wrap mt-2 mt-md-0">
              <button class="btn btn-sm btn-outline-primary" (click)="toggleEdit()">
                @if (!isEditing) {
                  <i class="bi bi-pencil"></i>
                } @else {
                  <i class="bi bi-save me-1"></i> Enregistrer
                }
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="onDeleteRoom()">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <ul class="list-unstyled mb-4">
            <li class="mb-2 d-flex align-items-center flex-wrap">
              <i class="bi bi-box-seam me-2"></i>
              Volume :
              @if (!isEditing) {
                <span class="ms-1">{{ room.volumeRoom }} m<sup>3</sup></span>
              } @else {
                <input
                  type="number"
                  class="form-control form-control-sm ms-2"
                  [(ngModel)]="room.volumeRoom">
              }
            </li>

            <li class="mb-2 d-flex align-items-center flex-wrap">
              <i class="bi bi-door-open me-2"></i>
              Portes :
              @if (!isEditing) {
                <span class="ms-1">{{ room.nbDoors }}</span>
              } @else {
                <input
                  type="number"
                  class="form-control form-control-sm ms-2"
                  [(ngModel)]="room.nbDoors">
              }
            </li>

            <li class="mb-2 d-flex align-items-center flex-wrap">
              <i class="bi bi-grid-3x2 me-2"></i>
              Surfaces vitrées :
              @if (!isEditing) {
                <span class="ms-1">{{ room.glazedSurface }} m<sup>2</sup></span>
              } @else {
                <input
                  type="number"
                  class="form-control form-control-sm ms-2"
                  [(ngModel)]="room.glazedSurface">
              }
            </li>

            <li class="mb-2 d-flex align-items-center flex-wrap">
              <i class="bi bi-house me-2"></i>
              Murs extérieurs :
              @if (!isEditing) {
                <span class="ms-1">{{ room.nbExteriorWalls }}</span>
              } @else {
                <input
                  type="number"
                  class="form-control form-control-sm ms-2"
                  [(ngModel)]="room.nbExteriorWalls">
              }
            </li>

            <li class="mb-2 d-flex align-items-center flex-wrap">
              <i class="bi bi-cpu me-2"></i>
              Ip du microcontrôleur :
              @if (!isEditing) {
                <span class="ms-1">{{ room.ipArduino }}</span>
              } @else {
                <input
                  type="text"
                  class="form-control form-control-sm ms-2"
                  [(ngModel)]="room.ipArduino">
              }
            </li>
          </ul>

          <div class="mb-3">
            <label class="form-label d-flex align-items-center gap-2">
              <i class="bi bi-thermometer-half text-danger"></i>
              Température min : {{ room.minTemp }} °C
            </label>
            <input
              type="range"
              class="form-range"
              min="16"
              max="26"
              step="1"
              [value]="room.minTemp"
              [disabled]="!isEditing"
              (input)="onMinTempChange($event)">
          </div>

          <div class="mb-3">
            <label class="form-label d-flex align-items-center gap-2">
              <i class="bi bi-thermometer-high text-danger"></i>
              Température max : {{ room.maxTemp }} °C
            </label>
            <input
              type="range"
              class="form-range"
              min="16"
              max="26"
              step="1"
              [value]="room.maxTemp"
              [disabled]="!isEditing"
              (input)="onMaxTempChange($event)">
          </div>

          <!-- Horaires semaine -->
          <h5 class="mt-4 mb-3">Horaires de la semaine</h5>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" (click)="prevDay()">&lt;</button>

            <div class="flex-grow-1 border rounded p-3 bg-body text-center">
              <div class="fw-bold mb-2">{{ dayTranslations[weekDays[currentDayIndex]] }}</div>

              <div class="d-flex justify-content-center gap-2 mb-2">
                <div>
                  <label class="form-label mb-0">Début</label>
                  <input type="text"
                         class="form-control form-control-sm"
                         [(ngModel)]="room.schedule[weekDays[currentDayIndex]].start"
                         [disabled]="!isEditing || room.schedule[weekDays[currentDayIndex]].isClosed"
                         placeholder="HH:mm">

                </div>

                <div>
                  <label class="form-label mb-0">Fin</label>
                  <input type="text"
                         class="form-control form-control-sm"
                         [(ngModel)]="room.schedule[weekDays[currentDayIndex]].end"
                         [disabled]="!isEditing || room.schedule[weekDays[currentDayIndex]].isClosed"
                         placeholder="HH:mm">
                </div>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [(ngModel)]="room.schedule[weekDays[currentDayIndex]].isClosed"
                  [disabled]="!isEditing"
                  (ngModelChange)="onToggleClosed(weekDays[currentDayIndex])">
                <label class="form-check-label" for="{{weekDays[currentDayIndex]}}Closed">
                  Fermé
                </label>
              </div>
            </div>

            <button class="btn btn-sm btn-outline-secondary" (click)="nextDay()">&gt;</button>
          </div>
        </div>


        <!-- Côté droit : graphes -->
        <div class="col-12 col-md-9 d-flex flex-column p-3">
          <div class="mb-3">
            <h2>Tableau de bord de la salle "{{room.nameRoom}}" du {{today}}</h2>
          </div>

          <div class="d-flex flex-column gap-4">
            @if (!room.ipArduino) {
              <div class="alert alert-warning text-center">
                Aucun microcontrôleur associé à cette salle
              </div>
            } @else {
              <app-sensor-graph
                [room]="room"
                valueKey="valueTemp"
                color="rgba(255,99,132,1)">
              </app-sensor-graph>

              <app-sensor-graph
                [room]="room"
                valueKey="valueCO2"
                color="rgba(54,162,235,1)">
              </app-sensor-graph>

              <app-sensor-graph
                [room]="room"
                valueKey="valueHum"
                color="rgba(75,192,92,1)">
              </app-sensor-graph>
            }
          </div>
        </div>
      </div>
    </div>
  }
}
